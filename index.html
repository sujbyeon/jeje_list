<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê°œë°œ êµ¬ì—­ ë§¤ë¬¼ List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root { 
            --brand-navy: #022136; 
            --brand-gold: #A78569; 
            --apple-bg: #f5f5f7; 
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --accent-blue: #0066CC;
        }

        * { 
            box-sizing: border-box; 
            -webkit-font-smoothing: antialiased; 
            letter-spacing: -0.02em; 
        }
        
        body { 
            font-family: "Pretendard Variable", sans-serif; 
            background-color: var(--apple-bg);
            color: var(--text-main); 
            margin: 0; 
            padding: 40px 20px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        /* í—¤ë” */
        header { 
            text-align: left;
            margin-bottom: 50px;
            border-left: 3px solid var(--brand-gold);
            padding-left: 20px;
            position: relative;
        }
        
        h1 { 
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800; 
            color: var(--brand-navy); 
            margin: 0 0 8px 0;
        }
        
        .subtitle { 
            font-size: clamp(14px, 3vw, 18px);
            color: var(--brand-gold); 
            font-weight: 600; 
            margin: 0;
        }

        .badge-info-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-sub);
            font-size: 13px;
            font-weight: 600;
            padding: 8px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-info-btn:hover {
            border-color: var(--brand-navy);
            color: var(--brand-navy);
        }

        /* ì§€ì—­ íƒ­ */
        .region-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .region-btn {
            padding: 10px 24px;
            border: 2px solid var(--border);
            background: var(--card-bg);
            cursor: pointer;
            font-weight: 800;
            font-size: 15px;
            color: var(--text-sub);
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .region-btn.active {
            background: var(--brand-navy);
            color: #FFFFFF;
            border-color: var(--brand-navy);
        }

        /* ì£¼ì†Œ íˆ´íŒ */
        .address-icon {
            font-size: 14px;
            color: var(--text-sub);
            cursor: help;
            position: relative;
            display: inline-block;
            margin-left: 4px;
        }

        .address-icon:hover::after {
            content: attr(data-address);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brand-navy);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
            z-index: 100;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .address-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--brand-navy);
            margin-bottom: 2px;
        }

        /* ë¬¼ê±´ì„¤ëª… */
        .description {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 4px;
            line-height: 1.5;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-sub);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--brand-navy);
        }

        .modal h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--brand-navy);
            margin: 0 0 24px 0;
            padding-right: 40px;
        }

        .badge-explain {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 3px solid transparent;
        }

        .badge-explain.urgent {
            border-left-color: #dc2626;
        }

        .badge-explain.value {
            border-left-color: #16a34a;
        }

        .badge-explain.plus {
            border-left-color: #9333ea;
        }

        .badge-explain h3 {
            font-size: 16px;
            font-weight: 800;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge-explain h3 .badge {
            font-size: 11px;
        }

        .badge-explain p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-main);
        }

        .badge-explain code {
            background: #e5e7eb;
            padding: 2px 6px;
            font-size: 13px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        /* ê²€ìƒ‰ ë° í•„í„° */
        .controls { 
            background: var(--card-bg);
            padding: 20px; 
            margin-bottom: 24px; 
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        
        .filter-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 2px;
        }
        
        .filter-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab-btn { 
            padding: 10px 18px;
            border: 1px solid var(--border); 
            background: var(--card-bg); 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 13px; 
            color: var(--text-sub); 
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
        }
        
        .tab-btn:active {
            transform: scale(0.97);
        }
        
        .tab-btn.active { 
            background: var(--brand-navy);
            color: #FFFFFF; 
            border-color: var(--brand-navy);
        }
        
        .tab-btn.fav-tab.active {
            background: var(--brand-gold);
            border-color: var(--brand-gold);
        }
        
        .search-row { 
            display: flex; 
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input { 
            flex: 1; 
            min-width: 200px;
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            font-size: 14px; 
            outline: none;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }
        
        .search-input:focus {
            border-color: var(--brand-navy);
        }
        
        .sort-select { 
            padding: 11px 14px; 
            border: 1px solid var(--border); 
            font-weight: 700; 
            font-size: 13px; 
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        .sort-select:focus {
            outline: none;
            border-color: var(--brand-navy);
        }

        /* í†µê³„ ë°°ë„ˆ */
        .stats-banner {
            background: var(--card-bg);
            border-top: 2px solid var(--brand-gold);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 24px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .stats-banner .zone-name {
            font-size: 16px;
            font-weight: 800;
            color: var(--brand-navy);
        }

        .stats-banner .stat-item-inline {
            color: var(--text-sub);
            font-weight: 600;
        }

        .stats-banner .stat-item-inline strong {
            color: var(--text-main);
            font-weight: 700;
        }

        .stats-banner .divider {
            color: var(--border);
        }

        /* ë§¤ë¬¼ ì¹´ë“œ */
        .grid { 
            display: grid; 
            gap: 12px;
        }
        
        .card { 
            background: var(--card-bg);
            border: 1px solid var(--border); 
            padding: 20px 24px; 
            display: flex; 
            align-items: center;
            gap: 16px;
            transition: all 0.25s ease;
            position: relative;
        }
        
        .card:hover {
            border-color: var(--brand-gold);
            box-shadow: 0 4px 16px rgba(167, 133, 105, 0.08);
        }

        .fav-btn { 
            font-size: 24px; 
            cursor: pointer; 
            color: #D1D5DB; 
            border: none; 
            background: none; 
            transition: all 0.2s ease;
            flex-shrink: 0;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .fav-btn:active {
            transform: scale(0.9);
        }
        
        .fav-btn.active { 
            color: var(--brand-gold);
        }

        .area-tag { 
            font-size: 16px; 
            font-weight: 800; 
            color: var(--brand-gold); 
            text-align: left;
            min-width: 100px;
            flex-shrink: 0;
        }

        .subject { 
            flex: 1; 
            min-width: 0;
        }
        
        .subject .title { 
            font-size: clamp(16px, 4vw, 18px);
            font-weight: 700; 
            color: var(--brand-navy); 
            margin-bottom: 6px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .subject .details { 
            font-size: 13px; 
            color: var(--text-sub); 
            font-weight: 400;
            line-height: 1.4;
        }

        /* ê°€ê²© ì •ë³´ */
        .price-box { 
            text-align: right; 
            padding: 12px 18px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .price-main { 
            font-size: clamp(20px, 4vw, 24px);
            font-weight: 900; 
            color: var(--brand-navy);
            line-height: 1.2;
        }
        
        .price-pyung { 
            font-size: 11px; 
            color: #64748b; 
            margin-top: 3px; 
            font-weight: 600;
        }

        /* ë²„íŠ¼ ì˜ì—­ */
        .action-box { 
            display: flex; 
            flex-direction: column; 
            gap: 6px;
            min-width: 105px;
            flex-shrink: 0;
        }
        
        .btn { 
            padding: 10px 14px;
            font-size: 12px; 
            font-weight: 700; 
            text-decoration: none; 
            text-align: center; 
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 38px;
        }
        
        .btn-main { 
            background: var(--brand-navy);
            color: #FFFFFF;
            border-color: var(--brand-navy);
        }
        
        .btn-main:hover {
            background: var(--brand-gold);
            border-color: var(--brand-gold);
        }
        
        .btn-sub { 
            background: var(--card-bg);
            color: var(--text-sub);
        }
        
        .btn-sub:hover {
            border-color: var(--brand-navy);
            color: var(--brand-navy);
        }

        /* ë°°ì§€ */
        .badge { 
            font-size: 12px; 
            font-weight: 800; 
            letter-spacing: -0.01em;
        }
        
        .b-urgent { 
            color: #dc2626;
        }
        
        .b-value { 
            color: #16a34a;
        }
        
        .b-plus { 
            color: #9333ea;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                padding: 20px 14px;
            }
            
            header {
                margin-bottom: 30px;
            }

            .badge-info-btn {
                position: static;
                margin-top: 12px;
                display: inline-block;
            }

            .region-tabs {
                gap: 8px;
            }

            .region-btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .controls {
                padding: 16px;
            }
            
            .filter-tabs {
                margin-bottom: 12px;
            }

            .stats-banner {
                gap: 12px;
                padding: 12px 16px;
                font-size: 13px;
            }

            .stats-banner .zone-name {
                font-size: 15px;
                flex-basis: 100%;
            }
            
            .card { 
                flex-direction: column; 
                align-items: stretch;
                padding: 18px;
                gap: 12px;
            }
            
            .fav-btn {
                position: absolute;
                top: 18px;
                right: 18px;
                z-index: 10;
            }
            
            .area-tag { 
                align-self: flex-start;
                margin-top: 6px;
            }
            
            .subject .title {
                padding-right: 40px;
            }
            
            .price-box { 
                text-align: left; 
                margin: 6px 0;
            }
            
            .action-box { 
                flex-direction: row;
                width: 100%;
                gap: 8px;
            }
            
            .btn { 
                flex: 1;
            }
        }

        /* ë¡œë”©/ë¹ˆ ìƒíƒœ */
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-sub);
            font-size: 14px;
        }

        .empty-state h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 6px;
        }

        .empty-state p {
            font-size: 13px;
            margin: 0;
        }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-sub);
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ì¬ê°œë°œ êµ¬ì—­ ë§¤ë¬¼</h1>
            <div class="subtitle" id="dateSubtitle">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            <button class="badge-info-btn" onclick="openModal()">ì•„ì´ì½˜ ì˜ë¯¸ ğŸ“–</button>
        </header>

        <div class="controls">
            <div class="region-tabs" id="regionTabs">
                <button class="region-btn active" data-region="ì „ì²´">ì „ì²´</button>
            </div>
            <div class="filter-tabs" id="filterTabs">
                <button class="tab-btn active" data-district="ì „ì²´">ì „ì²´ ë§¤ë¬¼</button>
                <button class="tab-btn fav-tab" data-district="ê´€ì‹¬">â˜… ê´€ì‹¬ ë§¤ë¬¼</button>
            </div>
            <div class="search-row">
                <input type="text" id="searchInput" class="search-input" placeholder="êµ¬ì—­ëª…, ë§¤ë¬¼ëª…, íƒœê·¸ ê²€ìƒ‰">
                <select id="sortSelect" class="sort-select">
                    <option value="priceLow">ë‚®ì€ ë§¤ë§¤ê°€</option>
                    <option value="pyungLow">ë‚®ì€ í‰ë‹¹ê°€</option>
                    <option value="landHigh">ëŒ€ì§€ì§€ë¶„ìˆœ</option>
                </select>
            </div>
        </div>

        <div class="stats-banner" id="statsBanner" style="display: none;"></div>

        <div class="grid" id="listingGrid">
            <div class="loading">ë§¤ë¬¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- ë°°ì§€ ì„¤ëª… ëª¨ë‹¬ -->
    <div class="modal" id="badgeModal" onclick="closeModal(event, 'badgeModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal(null, 'badgeModal')">Ã—</button>
            <h2>ì•„ì´ì½˜ ì˜ë¯¸ ì•ˆë‚´</h2>
            
            <div class="badge-explain urgent">
                <h3><span class="badge b-urgent">ğŸš¨ ì´ˆê¸‰ë§¤</span></h3>
                <p><strong>ê¸°ì¤€:</strong> êµ¬ì—­ í‰ê· ê°€ë³´ë‹¤ 12% ì´ìƒ ì €ë ´í•  ë•Œ</p>
                <p><strong>ê³„ì‚°:</strong> <code>ë‚´ í‰ë‹¹ê°€ < (êµ¬ì—­ í‰ê· ê°€ Ã— 0.88)</code></p>
                <p><strong>ì˜ë¯¸:</strong> ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë©°, ë¹ ë¥¸ ê²€í† ê°€ í•„ìš”í•œ ê¸‰ë§¤ë¬¼ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="badge-explain value">
                <h3><span class="badge b-value">âœ… ê°€ì„±ë¹„</span></h3>
                <p><strong>ê¸°ì¤€:</strong> êµ¬ì—­ í‰ê· ê°€ë³´ë‹¤ 3% ~ 12% ì‚¬ì´ë¡œ ì €ë ´í•  ë•Œ</p>
                <p><strong>ê³„ì‚°:</strong> <code>ë‚´ í‰ë‹¹ê°€ < (êµ¬ì—­ í‰ê· ê°€ Ã— 0.97)</code></p>
                <p><strong>ì˜ë¯¸:</strong> ì´ˆë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë©°, í•©ë¦¬ì ì¸ ê°€ê²©ëŒ€ì˜ ë§¤ë¬¼ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="badge-explain plus">
                <h3><span class="badge b-plus">ğŸ’œ 1+1 ê°€ëŠ¥</span></h3>
                <p><strong>ì˜ë¯¸:</strong> í•´ë‹¹ ë§¤ë¬¼ì´ 1+1 ì‹ ì²­ì´ ê°€ëŠ¥í•œ ë¬¼ê±´ì…ë‹ˆë‹¤.</p>
                <p><strong>1+1 ê²€í† :</strong> 59ë³´ë‹¤ ì‘ì€ í‰í˜•ì´ ìˆë‹¤ë©´ 1+1ì´ ê°€ëŠ¥í• ìˆ˜ë„ ìˆëŠ” ë¬¼ê±´ì…ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        var SHEET_ID = '1kop_qWYOEQ4VWB7f-IWaGnrt0kwguCzjTnEBR4FtDKk';
        var TAB_NAME = 'LIST';
        var allData = [];
        var currentRegion = 'ì „ì²´';
        var currentDistrict = 'ì „ì²´';
        var favorites = JSON.parse(localStorage.getItem('redev_favs') || '[]');

        function toNumMan(val) {
            if (!val) return 0;
            let num = parseFloat(String(val).replace(/,/g, '').replace(/[^0-9.-]+/g, "")) || 0;
            if (num >= 1000000) return num / 10000; 
            return num;
        }

        function formatPrice(valMan) {
            if (valMan >= 10000) {
                const uk = Math.floor(valMan / 10000);
                const rest = valMan % 10000;
                return rest > 0 ? `${uk}ì–µ ${rest.toLocaleString()}` : `${uk}ì–µ`;
            }
            return valMan.toLocaleString() + "ë§Œì›";
        }

        function formatDateFull(dateStr) {
            if (!dateStr) return '';
            
            // í•œê¸€ í˜•ì‹ íŒŒì‹±: "2ì›” 20ì¼" â†’ "2025ë…„ 2ì›” 20ì¼"
            const koreanMatch = dateStr.match(/(\d+)ì›”\s*(\d+)ì¼/);
            if (koreanMatch) {
                const currentYear = new Date().getFullYear();
                const month = parseInt(koreanMatch[1]);
                const day = parseInt(koreanMatch[2]);
                return `${currentYear}ë…„ ${month}ì›” ${day}ì¼`;
            }
            
            // ISO í˜•ì‹ ì‹œë„
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}ë…„ ${month}ì›” ${day}ì¼`;
            }
            
            return '';
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            
            // í•œê¸€ í˜•ì‹ íŒŒì‹±: "2ì›” 20ì¼" â†’ "2/20"
            const koreanMatch = dateStr.match(/(\d+)ì›”\s*(\d+)ì¼/);
            if (koreanMatch) {
                const month = parseInt(koreanMatch[1]);
                const day = parseInt(koreanMatch[2]);
                return `${month}/${day}`;
            }
            
            // ISO í˜•ì‹ ì‹œë„
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            }
            
            return '';
        }

        function updateHeaderDate() {
            const dates = allData.map(item => item['ë‚ ì§œ']).filter(Boolean);
            if (dates.length > 0) {
                const latestDate = dates.sort().reverse()[0];
                document.getElementById('dateSubtitle').textContent = `${formatDateFull(latestDate)} ì—…ë°ì´íŠ¸`;
            } else {
                document.getElementById('dateSubtitle').textContent = 'Investment Analysis Dashboard';
            }
        }

        function toggleFav(id) {
            const idx = favorites.indexOf(id);
            if (idx > -1) favorites.splice(idx, 1);
            else favorites.push(id);
            localStorage.setItem('redev_favs', JSON.stringify(favorites));
            applyFilters();
        }

        function fetchData() {
            var url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?tqx=out:json;responseHandler:gvizCallback&sheet=' + encodeURIComponent(TAB_NAME);
            var script = document.createElement('script');
            script.src = url;
            document.body.appendChild(script);
        }

        window.gvizCallback = function(response) {
            var table = response.table;
            var cols = table.cols;
            allData = table.rows.map(function(row, idx) {
                var obj = { _id: 'item_' + idx };
                row.c.forEach(function(cell, i) {
                    var label = cols[i] ? cols[i].label.trim() : 'col'+i;
                    obj[label] = cell ? (cell.f || cell.v) : '';
                });
                return obj;
            });
            buildRegionTabs();
            buildFilters();
            updateHeaderDate();
            applyFilters();
        };

        function buildRegionTabs() {
            var regions = [...new Set(allData.map(item => item['ì§€ì—­']).filter(Boolean))];
            if (regions.length === 0) return;
            
            var container = document.getElementById('regionTabs');
            regions.forEach(function(r) {
                var btn = document.createElement('button');
                btn.className = 'region-btn';
                btn.dataset.region = r;
                btn.textContent = r;
                container.appendChild(btn);
            });
            
            container.onclick = function(e) {
                if (!e.target.matches('.region-btn')) return;
                document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentRegion = e.target.dataset.region;
                buildFilters();
                applyFilters();
            };
        }

        function buildFilters() {
            var filtered = currentRegion === 'ì „ì²´' ? allData : allData.filter(item => item['ì§€ì—­'] === currentRegion);
            var districts = [...new Set(filtered.map(item => item['êµ¬ì—­ëª…']).filter(Boolean))];
            var container = document.getElementById('filterTabs');
            
            // ê¸°ì¡´ êµ¬ì—­ íƒ­ ì œê±° (ì „ì²´, ê´€ì‹¬ ì œì™¸)
            Array.from(container.children).forEach(btn => {
                if (btn.dataset.district !== 'ì „ì²´' && btn.dataset.district !== 'ê´€ì‹¬') {
                    btn.remove();
                }
            });
            
            districts.forEach(function(d) {
                var btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.dataset.district = d;
                btn.textContent = d;
                container.insertBefore(btn, container.lastElementChild);
            });
            
            container.onclick = function(e) {
                if (!e.target.matches('.tab-btn')) return;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentDistrict = e.target.dataset.district;
                applyFilters();
            };
            
            // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
            document.querySelector('.tab-btn').classList.add('active');
            currentDistrict = 'ì „ì²´';
        }

        function renderListings(data) {
            var grid = document.getElementById('listingGrid');
            
            if (data.length === 0) {
                document.getElementById('statsBanner').style.display = 'none';
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }

            // í†µê³„ ê³„ì‚°
            let totalPrice = 0;
            let totalUnit = 0;
            let urgentCount = 0;
            let valueCount = 0;
            let onePlusOneCount = 0;

            data.forEach(item => {
                const price = toNumMan(item['ê±°ë˜ê°€(ìˆ«ì)']);
                const type = item['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const isDetached = type.includes('ë‹¨ë…') || type.includes('ìƒê°€');
                const area = isDetached ? parseFloat(item['ê³µê¸‰']) : parseFloat(item['ì „ìš©']);
                const onePlusOne = item['1+1 ê°€ëŠ¥'] || '';

                if (price > 0 && area > 0) {
                    totalPrice += price;
                    totalUnit += (price / area);
                }

                if (onePlusOne.includes('ê°€ëŠ¥') || onePlusOne.includes('ê²€í† ')) {
                    onePlusOneCount++;
                }
            });

            const avgPrice = totalPrice / data.length;
            const avgUnit = totalUnit / data.length;
            const avgPyung = Math.round(avgUnit * 3.3058);

            // ê¸‰ë§¤/ê°€ì„±ë¹„ ê³„ì‚°
            data.forEach(item => {
                const price = toNumMan(item['ê±°ë˜ê°€(ìˆ«ì)']);
                const type = item['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const isDetached = type.includes('ë‹¨ë…') || type.includes('ìƒê°€');
                const area = isDetached ? parseFloat(item['ê³µê¸‰']) : parseFloat(item['ì „ìš©']);
                
                if (price > 0 && area > 0) {
                    const unit = price / area;
                    if (unit < avgUnit * 0.88) urgentCount++;
                    else if (unit < avgUnit * 0.97) valueCount++;
                }
            });

            // í†µê³„ ë°°ë„ˆ ì—…ë°ì´íŠ¸
            const banner = document.getElementById('statsBanner');
            const zoneName = currentDistrict === 'ì „ì²´' ? 'ì „ì²´ ë§¤ë¬¼' : currentDistrict === 'ê´€ì‹¬' ? 'ê´€ì‹¬ ë§¤ë¬¼' : currentDistrict;
            banner.innerHTML = `
                <span class="zone-name">${zoneName}</span>
                <span class="stat-item-inline"><strong>${data.length}ê°œ</strong></span>
                <span class="divider">|</span>
                <span class="stat-item-inline">í‰ê·  <strong>${formatPrice(Math.round(avgPrice))}</strong></span>
                <span class="divider">|</span>
                <span class="stat-item-inline">í‰ë‹¹ <strong>${avgPyung.toLocaleString()}ë§Œ</strong></span>
                <span class="divider">|</span>
                <span class="stat-item-inline">ğŸš¨ <strong>${urgentCount}</strong></span>
                <span class="stat-item-inline">âœ… <strong>${valueCount}</strong></span>
                <span class="stat-item-inline">ğŸ’œ <strong>${onePlusOneCount}</strong></span>
            `;
            banner.style.display = 'flex';
            
            const zoneStats = {};
            allData.forEach(item => {
                const zone = item['êµ¬ì—­ëª…'];
                const type = item['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const isDetached = type.includes('ë‹¨ë…') || type.includes('ìƒê°€');
                const price = toNumMan(item['ê±°ë˜ê°€(ìˆ«ì)']);
                const area = isDetached ? parseFloat(item['ê³µê¸‰']) : parseFloat(item['ì „ìš©']);
                if (price > 0 && area > 0) {
                    if (!zoneStats[zone]) zoneStats[zone] = { totalUnit: 0, count: 0 };
                    zoneStats[zone].totalUnit += (price / area);
                    zoneStats[zone].count++;
                }
            });

            const sortVal = document.getElementById('sortSelect').value;
            data.sort((a, b) => {
                const priceA = toNumMan(a['ê±°ë˜ê°€(ìˆ«ì)']);
                const priceB = toNumMan(b['ê±°ë˜ê°€(ìˆ«ì)']);
                const typeA = a['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const typeB = b['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const areaA = (typeA.includes('ë‹¨ë…') || typeA.includes('ìƒê°€')) ? parseFloat(a['ê³µê¸‰']) : parseFloat(a['ì „ìš©']);
                const areaB = (typeB.includes('ë‹¨ë…') || typeB.includes('ìƒê°€')) ? parseFloat(b['ê³µê¸‰']) : parseFloat(b['ì „ìš©']);
                if (sortVal === 'priceLow') return priceA - priceB;
                if (sortVal === 'pyungLow') return (priceA/areaA) - (priceB/areaB);
                if (sortVal === 'landHigh') return parseFloat(b['ê³µê¸‰']) - parseFloat(a['ê³µê¸‰']);
                return 0;
            });

            grid.innerHTML = data.map(function(item) {
                const isFav = favorites.includes(item._id);
                const price = toNumMan(item['ê±°ë˜ê°€(ìˆ«ì)']);
                const type = item['ë¶€ë™ì‚°ìœ í˜•'] || '';
                const isDetached = type.includes('ë‹¨ë…') || type.includes('ìƒê°€');
                const area = isDetached ? parseFloat(item['ê³µê¸‰']) : parseFloat(item['ì „ìš©']);
                const tags = item['íƒœê·¸'] || '';
                const onePlusOne = item['1+1 ê°€ëŠ¥'] || '';
                const description = item['ë¬¼ê±´ì„¤ëª…'] || '';
                const address = item['ì£¼ì†Œ'] || '';
                const itemDate = item['ë‚ ì§œ'] ? `ğŸ“… ${formatDateShort(item['ë‚ ì§œ'])}` : '';
                let badges = '';
                
                // 1+1 ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
                if (onePlusOne.includes('ê°€ëŠ¥')) {
                    badges += '<span class="badge b-plus">1+1 ê°€ëŠ¥</span>';
                } else if (onePlusOne.includes('ê²€í† ')) {
                    badges += '<span class="badge b-plus">1+1 ê²€í† </span>';
                } else if (tags.includes('1+1')) {
                    badges += '<span class="badge b-plus">1+1</span>';
                }

                let pyungPrice = 0;
                let areaType = '';
                if (price > 0 && area > 0) {
                    const curUnit = price / area;
                    const avgUnit = zoneStats[item['êµ¬ì—­ëª…']] ? zoneStats[item['êµ¬ì—­ëª…']].totalUnit / zoneStats[item['êµ¬ì—­ëª…']].count : 0;
                    pyungPrice = Math.round(curUnit * 3.3058);
                    areaType = isDetached ? 'ëŒ€ì§€' : 'ì „ìš©';
                    if (avgUnit > 0 && curUnit < avgUnit * 0.88) badges += '<span class="badge b-urgent">ê¸‰ë§¤</span>';
                    else if (avgUnit > 0 && curUnit < avgUnit * 0.97) badges += '<span class="badge b-value">ê°€ì„±ë¹„</span>';
                }

                return `
                    <div class="card">
                        <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${item._id}')" aria-label="ê´€ì‹¬ ë§¤ë¬¼">â˜…</button>
                        <div class="area-tag">${item['êµ¬ì—­ëª…']}</div>
                        <div class="subject">
                            <div class="title">
                                ${item['ë¬¼ê±´ëª…']} 
                                ${badges}
                                ${address ? `<span class="address-icon" data-address="${address}">ğŸ“</span>` : ''}
                            </div>
                            <div class="details">ëŒ€ì§€ ${item['ê³µê¸‰']}ã¡ Â· ì „ìš© ${item['ì „ìš©']}ã¡ Â· ${tags}${itemDate ? ' Â· ' + itemDate : ''}</div>
                            ${description ? `<div class="description">${description}</div>` : ''}
                        </div>
                        <div class="price-box">
                            <div class="price-main">${formatPrice(price)}</div>
                            <div class="price-pyung">í‰ë‹¹ ${pyungPrice.toLocaleString()}ë§Œ (${areaType})</div>
                        </div>
                        <div class="action-box">
                            <a href="${item['ìƒì„¸ë³´ê¸°']}" target="_blank" class="btn btn-main">ìƒì„¸ ì •ë³´</a>
                            <a href="${item['ìœ„ì¹˜ë³´ê¸°']}" target="_blank" class="btn btn-sub">ìœ„ì¹˜ë³´ê¸°</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(i => {
                const matchRegion = currentRegion === 'ì „ì²´' || i['ì§€ì—­'] === currentRegion;
                const matchDist = (currentDistrict === 'ì „ì²´') || (currentDistrict === 'ê´€ì‹¬' ? favorites.includes(i._id) : i['êµ¬ì—­ëª…'] === currentDistrict);
                const matchSearch = !term || ['ë¬¼ê±´ëª…', 'êµ¬ì—­ëª…', 'íƒœê·¸', 'ë¬¼ê±´ì„¤ëª…'].some(k => i[k] && i[k].toLowerCase().includes(term));
                return matchRegion && matchDist && matchSearch;
            });
            renderListings(filtered);
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('sortSelect').addEventListener('change', applyFilters);
        fetchData();

        // ëª¨ë‹¬ ì œì–´
        function openModal(modalId) {
            if (!modalId) modalId = 'badgeModal';
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event, modalId) {
            if (!modalId) modalId = 'badgeModal';
            if (!event || event.target.id === modalId || event.target.className === 'modal-close') {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal(null, 'badgeModal');
            }
        });
    </script>
</body>
</html>
